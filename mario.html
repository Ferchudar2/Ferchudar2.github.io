<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web_GitHub - Unificado</title>
    <style>
        /* --- 1. ESTILOS BASE Y CENTRADO DE CONTENIDO (Forms) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8; /* Fondo suave */
            margin: 0;
            padding: 0;
            /* Ajuste clave para que el contenido se apile debajo del header */
            display: block; 
            min-height: auto;
            /* Añadimos padding superior para compensar el header */
            padding-top: 60px; 
        }
        /* Contenedor general para secciones */
        .page { display: none; padding: 20px; }
        .page.active { display: block; }

        /* --- 2. CONTENEDOR PRINCIPAL (Caja Blanca de Login/Registro) --- */
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%; /* Ajuste para móviles */
            margin: 20px auto; /* Centrar y separar del header */
        }

        h2, h3 { text-align: center; color: #333; }

        /* --- 3. ESTILOS DE FORMULARIO --- */
        form { display: flex; flex-direction: column; gap: 15px; }

        input, select, button, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus { border-color: #3b82f6; outline: none; }

        button, input[type="submit"] {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover, input[type="submit"]:hover { background-color: #2563eb; }

        /* --- 4. ESTILOS PARA LA BARRA DE NAVEGACIÓN (HEADER) --- */
        #main-header {
            background-color: #3b82f6; 
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 100%;
            position: fixed; /* Lo fija en la parte superior */
            top: 0;
            left: 0;
            z-index: 1000; /* Asegura que esté por encima de todo */
        }

        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

        .logo { font-size: 1.8rem; margin: 0; }

        nav ul { list-style: none; padding: 0; margin: 0; display: flex; gap: 12px; }

        nav ul li { display: inline; }

        nav ul li a { color: white; text-decoration: none; padding: 8px 10px; border-radius: 5px; transition: background-color 0.3s; font-weight: 500; }

        nav ul li a:hover { background-color: #2563eb; }

        .user-info { font-weight: bold; color: #ffd700; padding: 5px 10px; }

        /* --- 5. ESTILOS PARA LA TABLA DE PRODUCTOS (productos.html) --- */
        .table-container { max-width: 1000px; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; border: 1px solid #e0e0e0; text-align: left; vertical-align: middle; }
        th { background-color: #3b82f6; color: white; font-weight: bold; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f0ff; }

        /* Estilos para las imágenes de producto */
        img { max-width: 60px; max-height: 60px; display: block; margin: 0 auto; border-radius: 5px; object-fit: contain; }

        td:nth-child(4), #acciones-header, td:last-child { text-align: center; }

        /* Extras responsive */
        @media (min-width: 900px) {
            .container { max-width: 600px; }
        }

        /* Estilos pequeños para acciones */
        .small-btn { padding: 6px 8px; font-size: 0.9rem; margin: 0 4px; }

        /* Mensajes */
        .msg { max-width: 1000px; margin: 10px auto; text-align: center; }

        /* Estilos específicos para la tabla de usuarios */
        #usuarios-tbody select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #usuarios-tbody button { padding: 5px 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header id="main-header">
        <div class="header-content">
            <h1 class="logo">Web_GitHub</h1>
            <nav>
                <ul id="nav-links">
                    <li><a href="#productos" data-link>Productos</a></li>
                    <li><a href="#agregar" data-link class="nav-admin">Agregar</a></li>
                    <li><a href="#registro" data-link>Registro</a></li>
                    <li><a href="#login" data-link>Iniciar Sesión</a></li>
                    <li><a href="#admin" data-link class="nav-admin">Usuarios</a></li>
                </ul>
            </nav>
            <div>
                <span id="user-display" class="user-info" style="display:none"></span>
                <button id="logout-btn" style="display:none" class="small-btn">Cerrar Sesión</button>
            </div>
        </div>
    </header>

    <!-- Mensaje general -->
    <div id="msg" class="msg"></div>

    <!-- PAGINA: PRODUCTOS -->
    <section id="productos" class="page">
        <div class="table-container">
            <h2>Productos</h2>
            <p>Listado de productos disponibles.</p>
            <table>
                <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th id="acciones-header">Stock</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productos-tbody"></tbody>
            </table>
        </div>
    </section>

    <!-- PAGINA: AGREGAR PRODUCTO -->
    <section id="agregar" class="page">
        <div class="container">
            <h2>Agregar Nuevo Producto</h2>
            <form id="form-agregar">
                <input type="text" name="nombre" placeholder="Nombre del producto" required>
                <input type="number" name="precio" step="0.01" placeholder="Precio" required>
                <input type="number" name="stock" placeholder="Stock disponible" required>
                <input type="text" name="imagen_url" placeholder="URL de la imagen (ej: imagen/foto.jpg)" required>
                <button type="submit">Guardar Producto</button>
            </form>
            <p style="text-align:center;"><a href="#productos">Volver a productos</a></p>
        </div>
    </section>

    <!-- PAGINA: EDITAR PRODUCTO -->
    <section id="editar" class="page">
        <div class="container">
            <h2>Editar Producto</h2>
            <form id="form-editar">
                <!-- Inputs se insertan dinámicamente -->
                <button type="submit">Actualizar Producto</button>
            </form>
            <p style="text-align:center;"><a href="#productos">Volver a productos</a></p>
        </div>
    </section>

    <!-- PAGINA: LOGIN -->
    <section id="login" class="page">
        <div class="container">
            <h2>Iniciar Sesión</h2>
            <form id="form-login">
                <input type="text" name="usuario" placeholder="Nombre de usuario" required>
                <input type="password" name="password" placeholder="Contraseña" required>
                <button type="submit">Ingresar</button>
            </form>
            <p style="text-align:center;">¿No tienes cuenta? <a href="#registro">Regístrate aquí</a></p>
        </div>
    </section>

    <!-- PAGINA: REGISTRO -->
    <section id="registro" class="page">
        <div class="container">
            <h2>Registro</h2>
            <form id="form-registro">
                <input type="text" name="usuario" placeholder="Usuario" required>
                <input type="text" name="nombre" placeholder="Nombre" required>
                <input type="email" name="email" placeholder="Email (opcional)">
                <input type="password" name="password" placeholder="Contraseña" required>
                <label><input type="checkbox" name="is_admin"> Registrar como admin</label>
                <button type="submit">Registrar</button>
            </form>
            <p style="text-align:center;"><a href="#login">Volver a login</a></p>
        </div>
    </section>

    <!-- PAGINA: ADMIN USUARIOS -->
    <section id="admin" class="page">
        <div class="table-container">
            <h2>Administración de Usuarios</h2>
            <p>Aquí puedes ver y cambiar los roles de los usuarios registrados.</p>
            <table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol Actual</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="usuarios-tbody"></tbody>
            </table>
        </div>
    </section>

    <script>
        /* ---------- Helpers de localStorage y datos ---------- */
        const LS_USERS_KEY = 'webgh_usuarios_v1';
        const LS_PRODUCTS_KEY = 'webgh_productos_v1';
        const LS_SESSION_KEY = 'webgh_sesion_v1';

        // Datos de ejemplo si no existen
        function seedIfEmpty() {
            if (!localStorage.getItem(LS_USERS_KEY)) {
                const demoUsers = [
                    { usuario: 'admin', nombre: 'Admin', email: 'admin@local', password: 'admin', rol: 'admin' },
                    { usuario: 'juan', nombre: 'Juan Perez', email: 'juan@mail', password: '1234', rol: 'cliente' }
                ];
                localStorage.setItem(LS_USERS_KEY, JSON.stringify(demoUsers));
            }
            if (!localStorage.getItem(LS_PRODUCTS_KEY)) {
                const demoProducts = [
                    { id: 1, nombre: 'Silla de Ruedas', precio: 15000, stock: 5, imagen_url: 'https://via.placeholder.com/80' },
                    { id: 2, nombre: 'Horse Mount Kit', precio: 25000, stock: 2, imagen_url: 'https://via.placeholder.com/80' }
                ];
                localStorage.setItem(LS_PRODUCTS_KEY, JSON.stringify(demoProducts));
            }
        }

        function getUsuarios() { return JSON.parse(localStorage.getItem(LS_USERS_KEY) || '[]'); }
        function saveUsuarios(u){ localStorage.setItem(LS_USERS_KEY, JSON.stringify(u)); }
        function getProductos(){ return JSON.parse(localStorage.getItem(LS_PRODUCTS_KEY) || '[]'); }
        function saveProductos(p){ localStorage.setItem(LS_PRODUCTS_KEY, JSON.stringify(p)); }

        function setLoggedInUser(user){ localStorage.setItem(LS_SESSION_KEY, JSON.stringify(user)); }
        function getLoggedInUser(){ return JSON.parse(localStorage.getItem(LS_SESSION_KEY) || 'null'); }
        function logout(){ localStorage.removeItem(LS_SESSION_KEY); renderNav(); routeTo('#login'); showMsg('Sesión cerrada'); }

        function isAdmin(){ const u = getLoggedInUser(); return u && u.rol === 'admin'; }

        /* ---------- Render Nav ---------- */
        function renderNav(){
            const user = getLoggedInUser();
            const userDisplay = document.getElementById('user-display');
            const logoutBtn = document.getElementById('logout-btn');
            document.querySelectorAll('.nav-admin').forEach(el => el.style.display = (user && user.rol==='admin') ? 'inline' : 'none');
            if (user) {
                userDisplay.style.display = 'inline-block';
                userDisplay.textContent = user.nombre ? user.nombre : user.usuario;
                logoutBtn.style.display = 'inline-block';
            } else {
                userDisplay.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        }

        document.getElementById('logout-btn').addEventListener('click', ()=>{ logout(); });

        /* ---------- Mensajes ---------- */
        function showMsg(text, timeout=3000){ const el = document.getElementById('msg'); el.textContent = text; if(timeout>0) setTimeout(()=>{ if(el.textContent===text) el.textContent=''; }, timeout); }

        /* ---------- RENDER PRODUCTOS ---------- */
        function renderProductos(){
            const tbody = document.getElementById('productos-tbody');
            const productos = getProductos();
            tbody.innerHTML = '';
            if(productos.length===0){ tbody.innerHTML = '<tr><td colspan="5">No hay productos.</td></tr>'; return; }
            productos.forEach(p=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${p.imagen_url}" alt="${p.nombre}"></td>
                    <td>${p.nombre}</td>
                    <td>$ ${Number(p.precio).toFixed(2)}</td>
                    <td style="text-align:center">${p.stock}</td>
                    <td style="text-align:center">
                        <button class="small-btn" onclick="irEditar(${p.id})">Editar</button>
                        <button class="small-btn" onclick="eliminarProducto(${p.id})">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        /* ---------- FUNCIONES PRODUCTOS ---------- */
        document.getElementById('form-agregar').addEventListener('submit', guardarProducto);
        function guardarProducto(e){
            e.preventDefault();
            if(!isAdmin()){ showMsg('Solo administradores pueden agregar productos',4000); routeTo('#login'); return; }
            const f = e.target;
            const nombre = f.nombre.value.trim();
            const precio = parseFloat(f.precio.value);
            const stock = parseInt(f.stock.value);
            const imagen_url = f.imagen_url.value.trim() || 'https://via.placeholder.com/80';
            const productos = getProductos();
            const id = productos.length? Math.max(...productos.map(x=>x.id))+1 : 1;
            productos.push({ id, nombre, precio, stock, imagen_url });
            saveProductos(productos);
            showMsg('Producto guardado');
            f.reset();
            renderProductos();
            routeTo('#productos');
        }

        function eliminarProducto(id){
            if(!confirm('¿Eliminar producto?')) return;
            const productos = getProductos().filter(p=>p.id!==id);
            saveProductos(productos);
            renderProductos();
            showMsg('Producto eliminado');
        }

        function irEditar(id){
            // Navegar a #editar?id=ID
            location.hash = `#editar?id=${id}`;
            router();
        }

        document.getElementById('form-editar').addEventListener('submit', actualizarProducto);
        function loadEditarForm(id){
            const productos = getProductos();
            const p = productos.find(x=>x.id===id);
            const form = document.getElementById('form-editar');
            if(!p){ form.innerHTML = '<p>Producto no encontrado.</p>'; return; }
            form.innerHTML = `
                <input type="hidden" name="id" value="${p.id}">
                <input type="text" name="nombre" value="${p.nombre}" required>
                <input type="number" step="0.01" name="precio" value="${p.precio}" required>
                <input type="number" name="stock" value="${p.stock}" required>
                <input type="text" name="imagen_url" value="${p.imagen_url}" required>
                <button type="submit">Actualizar Producto</button>
            `;
        }
        function actualizarProducto(e){
            e.preventDefault();
            if(!isAdmin()){ showMsg('Solo administradores pueden editar productos',4000); routeTo('#login'); return; }
            const f = e.target;
            const id = parseInt(f.id.value);
            const productos = getProductos();
            const idx = productos.findIndex(p=>p.id===id);
            if(idx===-1){ showMsg('Producto no encontrado'); return; }
            productos[idx].nombre = f.nombre.value.trim();
            productos[idx].precio = parseFloat(f.precio.value);
            productos[idx].stock = parseInt(f.stock.value);
            productos[idx].imagen_url = f.imagen_url.value.trim() || 'https://via.placeholder.com/80';
            saveProductos(productos);
            showMsg('Producto actualizado');
            renderProductos();
            routeTo('#productos');
        }

        /* ---------- AUTENTICACIÓN / REGISTRO ---------- */
        document.getElementById('form-login').addEventListener('submit', handleLogin);
        function handleLogin(e){
            e.preventDefault();
            const f = e.target;
            const usuario = f.usuario.value.trim();
            const password = f.password.value;
            const usuarios = getUsuarios();
            const u = usuarios.find(x=>x.usuario===usuario && x.password===password);
            if(!u){ showMsg('Credenciales inválidas',4000); return; }
            setLoggedInUser(u);
            showMsg('Bienvenido '+(u.nombre||u.usuario));
            renderNav();
            routeTo('#productos');
        }

        document.getElementById('form-registro').addEventListener('submit', handleRegistro);
        function handleRegistro(e){
            e.preventDefault();
            const f = e.target;
            const usuario = f.usuario.value.trim();
            const nombre = f.nombre.value.trim();
            const email = f.email.value.trim();
            const password = f.password.value;
            const is_admin = f.is_admin.checked;
            const usuarios = getUsuarios();
            if(usuarios.some(u=>u.usuario===usuario)){ showMsg('Usuario ya existe',4000); return; }
            usuarios.push({ usuario, nombre, email, password, rol: is_admin? 'admin' : 'cliente' });
            saveUsuarios(usuarios);
            showMsg('Usuario registrado correctamente');
            f.reset();
            routeTo('#login');
        }

        /* ---------- ADMIN USUARIOS ---------- */
        function renderUsuarios(){
            const usuarios = getUsuarios();
            const tbody = document.getElementById('usuarios-tbody');
            tbody.innerHTML = '';
            if(usuarios.length===0){ tbody.innerHTML = '<tr><td colspan="5">No hay usuarios registrados.</td></tr>'; return; }
            const current = getLoggedInUser();
            usuarios.forEach(usuario=>{
                if(current && usuario.usuario===current.usuario) return; // no mostrar al mismo
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${usuario.usuario}</td>
                    <td>${usuario.nombre}</td>
                    <td>${usuario.email||'N/A'}</td>
                    <td>
                        <select id="rol-${usuario.usuario}">
                            <option value="cliente" ${usuario.rol==='cliente'? 'selected':''}>Cliente</option>
                            <option value="admin" ${usuario.rol==='admin'? 'selected':''}>Administrador</option>
                        </select>
                    </td>
                    <td style="text-align:center"><button class="small-btn" onclick="cambiarRol('${usuario.usuario}')">Guardar</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function cambiarRol(username){
            if(!isAdmin()){ showMsg('Acceso denegado'); return; }
            const select = document.getElementById(`rol-${username}`);
            if(!select) return;
            const usuarios = getUsuarios();
            const idx = usuarios.findIndex(u=>u.usuario===username);
            if(idx===-1) return;
            usuarios[idx].rol = select.value;
            saveUsuarios(usuarios);
            showMsg('Rol actualizado');
            renderUsuarios();
            renderNav();
        }

        /* ---------- RUTEO simple con anclas ---------- */
        function parseHash(){
            const h = location.hash || '#productos';
            // soporte para #editar?id=3
            const [section, query] = h.split('?');
            const params = new URLSearchParams(query || '');
            return { section: section, params };
        }

        function routeTo(hash){ location.hash = hash; }

        function hideAllPages(){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); }

        function router(){
            const { section, params } = parseHash();
            hideAllPages();
            switch(section){
                case '#agregar':
                    document.getElementById('agregar').classList.add('active');
                    break;
                case '#editar':
                    if(!isAdmin()){ showMsg('Acceso denegado. Solo administradores.'); routeTo('#login'); return; }
                    document.getElementById('editar').classList.add('active');
                    const id = parseInt(params.get('id'));
                    if(!isNaN(id)) loadEditarForm(id);
                    break;
                case '#login': document.getElementById('login').classList.add('active'); break;
                case '#registro': document.getElementById('registro').classList.add('active'); break;
                case '#admin':
                    if(!isAdmin()){ showMsg('Acceso denegado. Solo administradores.'); routeTo('#login'); return; }
                    document.getElementById('admin').classList.add('active');
                    renderUsuarios();
                    break;
                case '#productos':
                default:
                    document.getElementById('productos').classList.add('active');
                    renderProductos();
                    break;
            }
        }

        window.addEventListener('hashchange', router);

        /* ---------- Inicialización ---------- */
        function init(){
            seedIfEmpty();
            renderNav();
            // enlazar clicks de nav para forzar router
            document.querySelectorAll('[data-link]').forEach(a=>a.addEventListener('click', (e)=>{ setTimeout(()=>router(), 50); }));
            // Si hash es #editar?id= se llama load
            router();
        }

        // Exponer funciones al scope global que se usan en HTML inline
        window.getLoggedInUser = getLoggedInUser;
        window.isAdmin = isAdmin;
        window.getProductos = getProductos;
        window.guardarProducto = guardarProducto;
        window.actualizarProducto = actualizarProducto;
        window.cambiarRol = cambiarRol;
        window.irEditar = irEditar;
        window.eliminarProducto = eliminarProducto;

        init();
    </script>
</body>
</html>
