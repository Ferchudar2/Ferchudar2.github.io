<?php
// Iniciar sesi√≥n
session_start();

// Verifica si la variable de sesi√≥n 'usuario' est√° definida. 
// Si no lo est√°, redirige al usuario a la p√°gina de inicio de sesi√≥n.
if (!isset($_SESSION["usuario"])) {
    header("Location: login.php");
    exit();
}

// ----------------------------------------------------
// 0. LEER PRODUCTOS LOCALES (MySQL) ‚Äî para mostrar imagen local
// ----------------------------------------------------
$db_server = "localhost";
$db_user = "root";
$db_password = "";
$db_name = "ferreteria_db";
$port = 3306;

$productos_locales = [];
$conn_fetch = @new mysqli($db_server, $db_user, $db_password, $db_name, $port);
if (!$conn_fetch->connect_error) {
    $sql_select = "SELECT id, descripcion, codigo, precio, stock, stock_minimo, importado, categoria, imagen FROM productos ORDER BY id DESC LIMIT 100";
    $resultado = $conn_fetch->query($sql_select);
    if ($resultado) {
        while ($fila = $resultado->fetch_assoc()) {
            $productos_locales[] = $fila;
        }
        $resultado->free();
    }
    $conn_fetch->close();
}

// Opcional: Obtener el nombre de usuario para mostrarlo en el panel
$usuario_actual = $_SESSION["usuario"];
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Simple Stock</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definici√≥n de colores principales (Azules del Login) */
        :root {
            --color-primary: #4b79a1; /* Azul principal */
            --color-dark: #283e51; /* Azul oscuro - Header */
            --color-gray-bg: #e5e7eb; /* Gris profesional */
        }
        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary-dark:hover { background-color: #35516a; }
        .text-dark { color: var(--color-dark); }
        .border-primary { border-color: var(--color-primary); }
        .resizable-box {
            resize: both;
            overflow: hidden;
            display: inline-block;
            border: 2px solid #000000ff; /* borde visible para agarrar */
        }

        .resizable-box {
            resize: both;
            overflow: hidden;
            display: block;

            width: 150px;        /* tama√±o inicial */
            height: 150px;

            max-width: 170px;    /* üî• L√çMITE REAL */
            max-height: 500px;   /* pod√©s cambiarlo si quer√©s */

            border-right: 2px solid #ccc; /* üî• ‚ÄúL√≠nea‚Äù visual opcional */
        }

        /* Imagen adentro */
        .resizable-box img {
            width: 100%;
            height: 100%;
            object-fit: fill; /* se deforma si quer√©s */
        }


        /* Estilos generales del cuerpo: Fondo gris profesional */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-color: var(--color-gray-bg); 
        }

        /* Responsive para el contenedor principal: 3/4 para la tabla, 1/4 para el sidebar */
        @media (min-width: 1024px) {
            .grid-layout {
                grid-template-columns: 3fr 1fr;
            }
        }

        /* Estilo para el stock bajo */
        .stock-bajo {
            background-color: #fef3c7; /* yellow-100 */
        }
    </style>
</head>
<body class="text-dark">

    <!-- CABECERA (Header) -->
    <header class="bg-dark text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-10">
        <div class="text-2xl font-bold">Sistema de Gesti√≥n - Ferreter√≠a</div>
        <div class="flex items-center space-x-4">
            <span class="text-sm">Usuario: <span class="font-semibold"><?php echo htmlspecialchars($usuario_actual); ?></span></span>
            <!-- Bot√≥n de Cerrar Sesi√≥n (Simulado) -->
            <a href="logout.php" class="bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4 rounded-lg transition-colors shadow-md">
                Cerrar Sesi√≥n
            </a>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main class="p-4 lg:p-8 min-h-[calc(100vh-64px)]">
        <div class="grid grid-cols-1 gap-8 lg:grid-layout">
            
            <!-- COLUMNA PRINCIPAL (Tabla de Art√≠culos y Controles) -->
            <section class="bg-white p-6 rounded-xl shadow-2xl flex flex-col h-[calc(100vh-100px)]"> 
                
                <!-- Controles Superiores de la Tabla -->
                <div class="flex flex-col lg:flex-row justify-between items-center mb-6 space-y-4 lg:space-y-0 lg:space-x-4">
                    <!-- B√∫squeda -->
                    <input type="text" id="search-input" placeholder="üîé Buscar Art√≠culo..." class="p-3 border border-gray-300 rounded-lg w-full lg:w-80 focus:ring-2 focus:ring-primary focus:border-primary transition-shadow">
                    
                    <!-- Contenedor de todos los botones de acci√≥n -->
                    <div class="flex flex-wrap justify-end gap-2 w-full lg:w-auto">
                        
                        <!-- ACCIONES R√ÅPIDAS (MOVIMIENTO ARRIBA Y BOTONES PEQUE√ëOS) -->
                        <button class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 font-semibold transition-colors shadow-md">Exportar Excel</button>
                        <button class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark font-semibold transition-colors shadow-md">Exportar PDF</button>
                        <button class="bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 font-semibold transition-colors shadow-md">Actualizar Precios</button>
                        <button class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 font-semibold transition-colors shadow-md">Stock Bajo</button>
                        
                        <!-- Botones de Acci√≥n de Art√≠culos -->
                        <a href="nuevo_articulo.php" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 font-semibold transition-colors flex items-center shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Nuevo Art√≠culo
                        </a>
                        <button class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark font-semibold transition-colors flex items-center shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0l2.122-2.122" />
                            </svg>
                            Editar
                        </button>
                        <button class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 font-semibold transition-colors flex items-center shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.223 9m-2.28 0a48.48 48.48 0 0110.02 0m-10.02 0l-.346-1.55a4.5 4.5 0 00-4.502-4.5H5.432a4.5 4.5 0 00-4.502 4.5L1.444 9m10.87-6.264L12 6.236m0 0a1.875 1.875 0 001.875-1.875V4.5m-3.75 0V6.236m0 0a1.875 1.875 0 00-1.875 1.875m-3.75 0V7.5m3.75 0a1.875 1.875 0 00-1.875 1.875v7.5m-3.75 0V7.5m3.75 0a1.875 1.875 0 00-1.875-1.875V4.5m3.75 0V6.236m0 0a1.875 1.875 0 001.875 1.875M12 6.236V4.5m-3.75 0a1.875 1.875 0 001.875 1.875M12 6.236V4.5m-3.75 0a1.875 1.875 0 001.875 1.875" />
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </div>

                <!-- Tabla de Datos (Contenedor que usa el espacio restante y es scrollable) -->
                <div class="overflow-x-auto border border-gray-300 rounded-lg shadow-inner flex-grow overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <!-- Cabecera de la tabla fija al hacer scroll -->
                        <thead class="bg-gray-100 text-xs uppercase tracking-wider text-gray-700 sticky top-0 shadow-sm">
                            <tr>
                                <th class="p-3 text-left">Imagen</th>
                                <th class="p-3 text-left">Categor√≠a / Descripci√≥n</th>
                                <th class="p-3 text-left">C√≥digo</th>
                                <th class="p-3 text-right">Precio</th>
                                <th class="p-3 text-right">Stock</th>
                                <th class="p-3 text-right">M√≠nimo</th>
                                <th class="p-3 text-right">Importado</th>
                            </tr>
                        </thead>
                        <!-- CUERPO DE LA TABLA (ID para inyecci√≥n de datos de Firebase) -->
                        <tbody id="products-table-body" class="bg-white divide-y divide-gray-100 text-sm">
                            <!-- Si hay productos locales los mostramos primero (imagen local) -->
                            <?php if (!empty($productos_locales)): ?>
                                <?php foreach ($productos_locales as $prod): 
                                        $img = !empty($prod['imagen']) ? htmlspecialchars($prod['imagen']) : '';
                                        $desc = htmlspecialchars($prod['descripcion']);
                                        $cod = htmlspecialchars($prod['codigo']);
                                        $precio_fmt = is_numeric($prod['precio']) ? number_format((float)$prod['precio'], 2, ',', '.') : '0,00';
                                        $stock = htmlspecialchars($prod['stock']);
                                        $min = htmlspecialchars($prod['stock_minimo']);
                                        $import = htmlspecialchars($prod['importado']);
                                ?>
                                <tr>
                                    <td class="px-6 py-3 whitespace-nowrap" style="width: 180px;">
                                        <?php if ($img): ?>
                                            <div class="resizable-box">
                                                <img src="<?php echo $img; ?>" alt="img">
                                            </div>
                                        <?php else: ?>
                                            <span class="text-gray-400">Sin imagen</span>
                                        <?php endif; ?>
                                    </td>
                                    <td class="px-6 py-3"><?php echo ($prod['categoria'] ? htmlspecialchars($prod['categoria']) . ' / ' : '') . $desc; ?></td>
                                    <td class="px-6 py-3 font-mono"><?php echo $cod; ?></td>
                                    <td class="px-6 py-3 text-right text-green-700 font-bold">$<?php echo $precio_fmt; ?></td>
                                    <td class="px-6 py-3 text-right"><?php echo $stock; ?></td>
                                    <td class="px-6 py-3 text-right text-red-500 font-semibold"><?php echo $min; ?></td>
                                    <td class="px-6 py-3 text-right"><?php echo $import; ?></td>
                                </tr>
                                <?php endforeach; ?>
                            <?php else: ?>
                                <!-- Fila de carga inicial, se reemplazar√° por JS (Firebase) si no hay locales -->
                                <tr>
                                    <td colspan="7" class="p-8 text-center text-gray-500 font-semibold">
                                        Cargando inventario...
                                    </td>
                                </tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- COLUMNA LATERAL DERECHA (Punto de Venta) -->
            <aside class="space-y-8">
                
                <!-- FACTURA / CARRITO (Mantengo los datos est√°ticos ya que no es el foco actual) -->
                <div class="bg-white p-6 rounded-xl shadow-2xl border-t-4 border-primary">
                    <h3 class="text-xl font-bold mb-4 pb-2 text-dark">FACTURA / CARRITO</h3>
                    
                    <div class="overflow-x-auto mb-4 border border-gray-300 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="text-xs uppercase text-gray-500 bg-gray-50">
                                <tr>
                                    <th class="p-2 text-left">Descripci√≥n</th>
                                    <th class="p-2 text-right">Precio</th>
                                    <th class="p-2 text-right">Cant</th>
                                    <th class="p-2 text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <!-- Elementos de Carrito Simulados -->
                                <tr><td class="p-2">Martillo</td><td class="p-2 text-right">1.500</td><td class="p-2 text-right">1</td><td class="p-2 text-right">1.500</td></tr>
                                <tr><td class="p-2">Codo PVC</td><td class="p-2 text-right">45.50</td><td class="p-2 text-right">10</td><td class="p-2 text-right">455.00</td></tr>
                                <!-- Fila de Total con fondo gris claro -->
                                <tr>
                                    <td colspan="3" class="p-2 font-bold text-right bg-gray-100">TOTAL:</td>
                                    <td class="p-2 text-right font-bold text-xl bg-gray-100 text-dark">$1.955,00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between gap-2 mt-4">
                        <button class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 font-semibold transition-colors shadow-md">
                            + Agregar
                        </button>
                        <button class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 font-semibold transition-colors shadow-md">
                            - Quitar
                        </button>
                        <button class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-dark font-semibold transition-colors shadow-md">
                            Facturar
                        </button>
                    </div>
                </div>
            </aside>
            
        </div>
    </main>

    <!-- Script de Firebase para la carga de datos del inventario -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const productsTableBody = document.getElementById('products-table-body');
        const searchInput = document.getElementById('search-input');
        let productsData = [];

        // Funci√≥n de utilidad para manejar la coma decimal y formato de moneda
        const formatCurrency = (amount) => {
            // Aseguramos que sea un n√∫mero antes de formatear
            if (typeof amount !== 'number' || isNaN(amount)) return '$0,00';
            return `$${amount.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // Funci√≥n para renderizar la tabla con un estado de carga o vac√≠o
        const setTableStatus = (message, isError = false) => {
            productsTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="p-8 text-center ${isError ? 'text-red-500' : 'text-gray-500'} font-semibold">
                        ${message}
                    </td>
                </tr>
            `;
        };
        
        // 1. AUTENTICACI√ìN
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Autenticaci√≥n exitosa
                fetchProductsRealtime();
            } else {
                // Si no hay usuario, intentar iniciar sesi√≥n an√≥nima o con token
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error al autenticar:", error.message);
                    setTableStatus(`Error de autenticaci√≥n. No se pudo cargar el inventario.`, true);
                }
            }
        });

        // 2. LECTURA EN TIEMPO REAL DE PRODUCTOS
        const fetchProductsRealtime = () => {
            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;
            const productsRef = collection(db, productsCollectionPath);
            const q = query(productsRef);

            // onSnapshot es el listener en tiempo real
            onSnapshot(q, (snapshot) => {
                productsData = [];
                snapshot.forEach((doc) => {
                    productsData.push({ id: doc.id, ...doc.data() });
                });
                
                // Si la colecci√≥n est√° vac√≠a, mostrar mensaje claro
                if (productsData.length === 0) {
                    setTableStatus('La colecci√≥n de art√≠culos est√° vac√≠a. ¬°Agrega un nuevo art√≠culo!');
                    return;
                }
                
                console.log("Datos de productos actualizados:", productsData.length);
                renderProducts(productsData);

            }, (error) => {
                console.error("Error al obtener los productos:", error);
                setTableStatus(`Error al cargar el inventario: ${error.message}. Verifica la consola.`, true);
            });
        };

        // 3. RENDERIZADO DE LA TABLA
        const renderProducts = (productsToRender) => {
            productsTableBody.innerHTML = ''; // Limpiar tabla
            
            if (productsToRender.length === 0) {
                setTableStatus('No se encontraron resultados para la b√∫squeda actual.');
                return;
            }

            productsToRender.forEach(product => {
                // Convertir a n√∫meros de forma segura
                const stock = parseInt(product.stock || 0);
                const stockMinimo = parseInt(product.stockMinimo || 0);
                const precio = parseFloat(product.precio || 0);
                const isImported = product.importado === true || product.importado === 'true'; // Manejar como booleano o string 'true'
                
                const isLowStock = stock < stockMinimo;
                const rowClass = isLowStock ? 'hover:bg-blue-50 stock-bajo' : 'hover:bg-blue-50';
                const stockClass = isLowStock ? 'text-red-600 font-semibold' : 'text-green-600';

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="p-3">
                        <img src="${product.imagen || 'uploads/default.png'}" class="w-12 h-12 object-cover rounded border" alt="img">
                    </td>
                    <td class="p-3 font-medium">${product.categoria || 'N/A'} / ${product.descripcion || 'Sin descripci√≥n'}</td>
                    <td class="p-3">${product.codigo || 'N/A'}</td>
                    <td class="p-3 text-right">${formatCurrency(precio)}</td>
                    <td class="p-3 text-right ${stockClass}">${stock}</td>
                    <td class="p-3 text-right">${stockMinimo}</td>
                    <td class="p-3 text-right">${isImported ? 'S√≠' : 'No'}</td>
                `;
                productsTableBody.appendChild(row);
            });
        };

        // 4. FUNCIONALIDAD DE B√öSQUEDA (Filtrado en el lado del cliente)
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm === "") {
                // Si vac√≠o, no tocamos los productos locales ya impresos; permitimos que Firebase vuelva a poblar si corresponde
                // Llamar a renderProducts para Firebase-data si est√° cargada
                if (productsData.length > 0) renderProducts(productsData);
                return;
            }

            // Filtrar tanto productos obtenidos por Firebase (si existen) como los locales
            const combined = [...(productsData || [] )];

            // Transformar productos locales a mismo formato (evitar duplicados si Firebase ya tiene las entradas)
            <?php if (!empty($productos_locales)): ?>
                (function(){
                    const localJS = <?php echo json_encode(array_map(function($p){
                        return [
                            'categoria' => $p['categoria'] ?? '',
                            'descripcion' => $p['descripcion'] ?? '',
                            'codigo' => $p['codigo'] ?? '',
                            'precio' => $p['precio'] ?? 0,
                            'stock' => $p['stock'] ?? 0,
                            'stockMinimo' => $p['stock_minimo'] ?? 0,
                            'importado' => $p['importado'] ?? 'No',
                            'imagen' => $p['imagen'] ?? ''
                        ];
                    }, $productos_locales)); ?>;

                    // A√±adir locales si no est√°n ya (comparando por c√≥digo)
                    localJS.forEach(l => {
                        const exists = combined.some(c => (c.codigo || '') === (l.codigo || ''));
                        if (!exists) combined.push(l);
                    });

                    // Reasignar combined en el scope superior
                    window.__combinedProducts = combined;
                })();
            <?php else: ?>
                window.__combinedProducts = combined;
            <?php endif; ?>

            const source = window.__combinedProducts || combined;

            const filtered = source.filter(product => {
                const searchString = `
                    ${product.categoria || ''}
                    ${product.descripcion || ''}
                    ${product.codigo || ''}
                    ${product.precio || ''}
                    ${product.stock || ''}
                    ${product.stockMinimo || ''}
                    ${product.importado || ''}
                `.toLowerCase();

                return searchString.includes(searchTerm);
            });

            // Renderizar filas filtradas
            if (filtered.length === 0) {
                setTableStatus('No se encontraron resultados para la b√∫squeda actual.');
                return;
            }

            productsTableBody.innerHTML = '';
            filtered.forEach(product => {
                const stock = parseInt(product.stock || 0);
                const stockMinimo = parseInt(product.stockMinimo || product.stock_minimo || 0);
                const precio = parseFloat(product.precio || 0);
                const isImported = product.importado === true || product.importado === 'true' || product.importado === 'S√≠';

                const isLowStock = stock < stockMinimo;
                const rowClass = isLowStock ? 'hover:bg-blue-50 stock-bajo' : 'hover:bg-blue-50';
                const stockClass = isLowStock ? 'text-red-600 font-semibold' : 'text-green-600';

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="p-3">
                        <div class="resizable-box" style="width:150px; height:150px;">
                            <img src="${product.imagen}" class="w-full h-full object-fill">
                        </div>
                    </td>

                    <td class="p-3 font-medium">
                        ${product.categoria || 'N/A'} / ${product.descripcion || 'Sin descripci√≥n'}
                    </td>

                    <td class="p-3">
                        ${product.codigo || 'N/A'}
                    </td>

                    <td class="p-3 text-right">
                        ${formatCurrency(precio)}
                    </td>

                    <td class="p-3 text-right ${stockClass}">
                        ${stock}
                    </td>

                    <td class="p-3 text-right">
                        ${stockMinimo}
                    </td>

                    <td class="p-3 text-right">
                        ${isImported ? 'S√≠' : 'No'}
                    </td>
                `;

                productsTableBody.appendChild(tr);
            });

        });

    </script>

</body>
</html>
