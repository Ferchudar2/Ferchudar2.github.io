<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tienda Pixel (Single HTML) - Fernando</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --g1:#2c5364; --g2:#203a43; --g3:#0f2027;
  --panel: rgba(0,0,0,0.8);
  --accent:#00bcd4; --accent-dark:#0097a7; --success:#00e676; --danger:#ff5252;
  --card:#101820; --muted:#b2ebf2;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif;background: linear-gradient(to right,var(--g1),var(--g2),var(--g3)); color:#fff;}
h2{font-family:'Press Start 2P',monospace;color:var(--accent);text-align:center;margin:0 0 12px}
a{color:var(--accent)}
/* container left (login/register) original look */
.container { background: var(--panel); padding: 20px; border-radius: 12px; width: 360px; box-shadow: 0 0 15px rgba(0,0,0,0.6); margin: 28px auto;}
.app-wrap{max-width:1100px;margin:28px auto;display:grid;grid-template-columns:360px 1fr;gap:20px;padding:0 12px}
@media(max-width:980px){ .app-wrap{grid-template-columns:1fr} .container{width:100%;margin:12px auto} }
.input, input[type="text"], input[type="password"], input[type="number"], select {
  width:100%; padding:10px; margin:6px 0; border:none; border-radius:5px; background-color:#1b1b1b; color:white; font-size:13px;
}
.input:focus{ outline: 2px solid rgba(0,188,212,0.12); box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
.btn { width:100%; padding:10px; background: var(--accent); border: none; color: #001; border-radius: 5px; cursor: pointer; font-weight: bold; font-family: 'Press Start 2P'; }
.btn:hover{ background: var(--accent-dark); transform: translateY(-2px); }
.btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:#dff; padding:8px; border-radius:8px; cursor:pointer; }
.link { color: var(--accent); text-decoration:none; font-weight:700; cursor:pointer; }
.small { text-align:center; color: var(--success); margin-top:8px; font-size:12px; }

/* Shop */
.shop-panel { background: var(--panel); padding: 20px; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.6); min-height: 420px; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:12px; }
.badge { background:rgba(0,0,0,0.25); padding:8px 10px; border-radius:8px; color:var(--muted); font-weight:700; font-size:12px; }
.pixel-deco { width:100%; height:8px; background:linear-gradient(90deg, rgba(0,188,212,0.12), rgba(0,230,118,0.06)); margin:10px 0; border-radius:2px; }

/* Grid & cards */
.grid { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; }
.product-card { background: var(--card); border: 3px solid rgba(0,188,212,0.08); border-radius:10px; width:220px; padding:12px; display:inline-block; vertical-align:top; transition: transform .12s ease, box-shadow .12s ease; image-rendering: pixelated; }
.product-card:hover{ transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.6); border-color: rgba(0,188,212,0.26); }
.product-card img{ width:100%; height:120px; object-fit:cover; border-radius:6px; margin-bottom:8px; image-rendering: pixelated; }
.product-card h4{ color:var(--muted); margin:6px 0; font-size:13px; font-family: 'Press Start 2P'; }
.product-card p{ margin:4px 0; color:#bfeff6; font-size:12px; }
.row { display:flex; gap:8px; margin-top:8px; }
.btn-small { padding:8px; border-radius:6px; border:0; cursor:pointer; font-weight:700; font-size:12px; }
.btn-buy { background:var(--accent); color:#001; border-radius:6px; }
.btn-edit { background:#ffd66b; color:#111 }
.btn-del { background:#ff7b7b; color:#111 }

/* admin panel small */
.admin-panel { background:rgba(0,0,0,0.45); padding:14px; border-radius:8px; margin-top:12px; }
.file-input { padding:8px; border-radius:6px; background:#111; color:#fff; border:1px dashed rgba(255,255,255,0.04); }

/* tables */
.table { width:100%; border-collapse:collapse; margin-top:10px; }
.table th, .table td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:left; font-size:12px; }
.table th { color:var(--muted); font-weight:800; font-family:'Press Start 2P'; font-size:11px; }

/* toasts */
.toasts { position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
.toast { background: rgba(0,0,0,0.6); padding:10px 14px; border-left:6px solid var(--accent); border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.6); font-weight:700; font-family:'Press Start 2P'; font-size:11px; color:#eafcff; }

/* modal-ish add panel */
#add-panel { display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:999; background:var(--panel); padding:18px; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.8); width:440px; }
#add-panel img{ width:100%; height:140px; object-fit:cover; border-radius:6px; display:block; margin-top:8px; image-rendering: pixelated; }
.hidden{display:none}
</style>
</head>
<body>

<div class="app-wrap">

  <!-- LEFT -->
  <div class="container">
    <div id="login-view">
      <h2>Iniciar sesiÃ³n</h2>
      <input id="login_user" class="input" type="text" placeholder="Usuario" autocomplete="username">
      <input id="login_pass" class="input" type="password" placeholder="ContraseÃ±a" autocomplete="current-password">
      <button id="btn-login" class="btn" type="button">ENTRAR</button>
      <p class="small">Â¿No tienes cuenta? <span id="to-register" class="link">Registrate</span></p>
      <p id="msg-login" class="small"></p>
    </div>

    <div id="register-view" style="display:none;margin-top:8px;">
      <h2>Registrarse</h2>
      <input id="reg_user" class="input" type="text" placeholder="Usuario">
      <input id="reg_pass" class="input" type="password" placeholder="ContraseÃ±a">
      <label style="font-size:12px;color:#bfeff6;margin-top:6px">ElegÃ­ rol:</label>
      <select id="reg_role" class="input">
        <option value="user">Usuario</option>
        <option value="admin">Administrador</option>
      </select>
      <button id="btn-register" class="btn" type="button">CREAR CUENTA</button>
      <p class="small">Â¿Ya tenÃ©s cuenta? <span id="to-login" class="link">Iniciar sesiÃ³n</span></p>
      <p id="msg-register" class="small"></p>
    </div>

    <div id="account-view" style="display:none;margin-top:6px;">
      <h2>Cuenta</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:11px;color:#bfeff6">Conectado como</div>
          <div id="user-name" style="font-weight:800;margin-top:6px;font-family:'Press Start 2P';font-size:12px"></div>
          <div id="user-role" style="color:#cde;font-size:11px"></div>
        </div>
        <div>
          <button id="btn-logout" class="btn-ghost" type="button" style="padding:8px;border-radius:8px">Cerrar</button>
        </div>
      </div>

      <div id="admin-actions" class="admin-panel" style="display:none;">
        <div style="display:flex;gap:8px;flex-direction:column">
          <button id="open-add" class="btn" type="button">âž• Agregar producto</button>
          <button id="view-all-purchases" class="btn-small" type="button" style="background:#111;color:#fff">Ver historial global</button>
          <button id="export-all" class="btn-small" type="button" style="background:#111;color:#fff">Exportar historial (CSV)</button>
          <button id="reset-sample" class="btn-small" type="button" style="background:#111;color:#fff">Reiniciar datos (prueba)</button>
        </div>
      </div>

      <div id="user-actions" class="admin-panel" style="display:none;margin-top:10px;">
        <div style="display:flex;gap:8px;flex-direction:column">
          <button id="view-my-purchases" class="btn" type="button">ðŸ“œ Mi historial</button>
          <button id="export-me" class="btn-small" type="button" style="background:#111;color:#fff">Exportar mi historial</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="shop-panel">
    <div class="header">
      <div>
        <h3 style="font-family:'Press Start 2P'">Tiendita Gamer (Pixel)</h3>
        <div style="font-size:12px;color:#bfeff6">ImÃ¡genes guardadas en tu navegador â€” archivo Ãºnico</div>
      </div>
      <div class="controls">
        <div id="status" class="badge">Invitado</div>
      </div>
    </div>

    <div class="pixel-deco"></div>
    <div id="products-area" class="grid" aria-live="polite"></div>

    <div id="hist-user" style="display:none;margin-top:12px">
      <h4 style="font-family:'Press Start 2P';font-size:12px;color:var(--accent)">Mi historial</h4>
      <table class="table" id="table-user"><thead><tr><th>Fecha</th><th>Producto</th><th>Precio</th><th>Cant</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="hist-all" style="display:none;margin-top:12px">
      <h4 style="font-family:'Press Start 2P';font-size:12px;color:var(--accent)">Historial global</h4>
      <table class="table" id="table-all"><thead><tr><th>Fecha</th><th>Usuario</th><th>Producto</th><th>Precio</th><th>Cant</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<!-- Add/Edit panel -->
<div id="add-panel">
  <h3 style="font-family:'Press Start 2P';font-size:13px;color:var(--accent)">Agregar / Editar producto</h3>
  <input id="p_name" class="input" placeholder="Nombre">
  <div style="display:flex;gap:8px">
    <input id="p_price" class="input" type="number" placeholder="Precio">
    <input id="p_stock" class="input" type="number" placeholder="Stock">
  </div>
  <input id="p_image" class="file-input" type="file" accept="image/*">
  <img id="p_preview" src="" alt="" style="display:none">
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="save-product" class="btn" type="button">GUARDAR</button>
    <button id="cancel-product" class="btn-ghost" type="button">CANCELAR</button>
    <button id="delete-product" class="btn-del" type="button" style="display:none">ELIMINAR</button>
  </div>
  <p id="add-msg" style="color:#bfeff6;font-size:12px;margin-top:8px"></p>
</div>

<div class="toasts" id="toasts"></div>

<script>
/* ======= LocalStorage keys & helpers ======= */
const KEYS = {
  USERS: 'fern_tienda_users_v1',
  PRODUCTS: 'fern_tienda_products_v1',
  SESSION: 'fern_tienda_session_v1',
  PURCHASES: 'fern_tienda_purchases_v1'
};
const dbGet = k => { const s = localStorage.getItem(k); return s ? JSON.parse(s) : null };
const dbSet = (k,v) => localStorage.setItem(k, JSON.stringify(v));

/* init */
if (!dbGet(KEYS.USERS)) dbSet(KEYS.USERS, [
  { user:'user', pass:'user', role:'user', compras:[] },
  { user:'admin', pass:'admin', role:'admin', compras:[] }
]);
if (!dbGet(KEYS.PRODUCTS)) dbSet(KEYS.PRODUCTS, [
  { id:Date.now()+1, nombre:'Camiseta Pixel', precio:1200, stock:5, imagen:'' },
  { id:Date.now()+2, nombre:'Gorra Pixel', precio:450, stock:8, imagen:'' }
]);
if (!dbGet(KEYS.PURCHASES)) dbSet(KEYS.PURCHASES, []);

/* ======= Elements ======= */
const loginView = document.getElementById('login-view'), registerView = document.getElementById('register-view'), accountView = document.getElementById('account-view');
const loginUser = document.getElementById('login_user'), loginPass = document.getElementById('login_pass'), btnLogin = document.getElementById('btn-login'), msgLogin = document.getElementById('msg-login');
const regUser = document.getElementById('reg_user'), regPass = document.getElementById('reg_pass'), regRole = document.getElementById('reg_role'), btnRegister = document.getElementById('btn-register'), msgRegister = document.getElementById('msg-register');
const toRegister = document.getElementById('to-register'), toLogin = document.getElementById('to-login');
const status = document.getElementById('status'), productsArea = document.getElementById('products-area');
const userName = document.getElementById('user-name'), userRole = document.getElementById('user-role'), btnLogout = document.getElementById('btn-logout');
const adminActions = document.getElementById('admin-actions'), userActions = document.getElementById('user-actions');
const openAdd = document.getElementById('open-add'), addPanel = document.getElementById('add-panel'), pName = document.getElementById('p_name'), pPrice = document.getElementById('p_price'), pStock = document.getElementById('p_stock'), pImage = document.getElementById('p_image'), pPreview = document.getElementById('p_preview');
const saveProduct = document.getElementById('save-product'), cancelProduct = document.getElementById('cancel-product'), deleteProductBtn = document.getElementById('delete-product'), addMsg = document.getElementById('add-msg');
const viewMy = document.getElementById('view-my-purchases'), viewAll = document.getElementById('view-all-purchases'), exportAll = document.getElementById('export-all'), resetSample = document.getElementById('reset-sample'), exportMe = document.getElementById('export-me');
const histUser = document.getElementById('hist-user'), tableUser = document.querySelector('#table-user tbody'), histAll = document.getElementById('hist-all'), tableAll = document.querySelector('#table-all tbody');
const toasts = document.getElementById('toasts');

/* toast */
function toast(txt, t=2600){ const el=document.createElement('div'); el.className='toast'; el.textContent=txt; toasts.appendChild(el); setTimeout(()=>{ el.style.opacity=0; el.style.transform='translateY(8px)'; setTimeout(()=>el.remove(),300) }, t); }

/* session helpers */
const getSession = ()=> localStorage.getItem(KEYS.SESSION);
const setSession = u=> localStorage.setItem(KEYS.SESSION, u);
const clearSession = ()=> localStorage.removeItem(KEYS.SESSION);

/* product helpers */
const getProducts = ()=> dbGet(KEYS.PRODUCTS) || [];
const setProducts = p=> dbSet(KEYS.PRODUCTS, p);

/* ======= Render products (delegation friendly) ======= */
function renderProducts(){
  const products = getProducts();
  productsArea.innerHTML = '';
  if (!products.length) { productsArea.innerHTML = '<div style="color:#bfeff6">No hay productos</div>'; return; }
  products.forEach(p=>{
    const card = document.createElement('div'); card.className='product-card'; card.dataset.id = p.id;
    const img = document.createElement('img'); img.src = p.imagen || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="140"><rect width="100%" height="100%" fill="%23070b0f"/></svg>';
    const h4 = document.createElement('h4'); h4.textContent = p.nombre;
    const price = document.createElement('p'); price.className='price'; price.textContent = '$' + Number(p.precio);
    const stock = document.createElement('p'); stock.className='stock'; stock.textContent = 'Stock: ' + p.stock;
    const row = document.createElement('div'); row.className='row';

    const buy = document.createElement('button'); buy.className='btn-small btn-buy'; buy.type='button'; buy.textContent='COMPRAR'; buy.dataset.action='buy';
    if (p.stock <= 0){ buy.disabled = true; buy.textContent = 'SIN STOCK'; buy.style.opacity = 0.6; }
    row.appendChild(buy);

    const session = getSession(); const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user === session);
    if (me && me.role === 'admin'){
      const edit = document.createElement('button'); edit.className='btn-small btn-edit'; edit.type='button'; edit.textContent='EDIT'; edit.dataset.action='edit';
      const del = document.createElement('button'); del.className='btn-small btn-del'; del.type='button'; del.textContent='DEL'; del.dataset.action='delete';
      row.appendChild(edit); row.appendChild(del);
    }

    card.appendChild(img); card.appendChild(h4); card.appendChild(price); card.appendChild(stock); card.appendChild(row);
    productsArea.appendChild(card);
  });
}

/* Delegation for product buttons (reliable when cards re-render) */
productsArea.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.dataset.action;
  const card = btn.closest('.product-card');
  if (!card) return;
  const id = Number(card.dataset.id);
  if (action === 'buy') return comprar(id);
  if (action === 'edit') return openAddPanel(id);
  if (action === 'delete') {
    if (!confirm('Eliminar producto?')) return;
    return deleteProductById(id);
  }
});

/* Delete (centralized) */
function deleteProductById(id){
  const prods = getProducts().filter(p => p.id !== id);
  setProducts(prods);
  renderProducts();
  toast('Producto eliminado');
}

/* Comprar */
function comprar(id){
  const prods = getProducts();
  const p = prods.find(x=>x.id === id);
  if (!p) return;
  if (p.stock <= 0){ toast('Sin stock'); return; }
  p.stock = p.stock - 1;
  setProducts(prods);
  const purchases = dbGet(KEYS.PURCHASES) || [];
  const fecha = new Date().toISOString();
  const usuario = getSession() || 'invitado';
  purchases.push({ fecha, usuario, productoId: p.id, nombre: p.nombre, precio: p.precio, cantidad: 1 });
  dbSet(KEYS.PURCHASES, purchases);
  const users = dbGet(KEYS.USERS) || [];
  const idx = users.findIndex(u=>u.user === usuario);
  if (idx >= 0){ users[idx].compras = users[idx].compras || []; users[idx].compras.push({ fecha, productoId: p.id, nombre: p.nombre, precio: p.precio, cantidad: 1 }); dbSet(KEYS.USERS, users); }
  toast('Comprado: ' + p.nombre);
  renderProducts(); renderHistories();
}

/* Histories */
function renderHistories(){
  const session = getSession();
  if (!session){ histUser.style.display='none'; histAll.style.display='none'; return; }
  const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user === session);
  tableUser.innerHTML = '';
  if (me && me.compras && me.compras.length){ histUser.style.display='block'; me.compras.slice().reverse().forEach(c=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${new Date(c.fecha).toLocaleString()}</td><td>${c.nombre}</td><td>$${c.precio}</td><td>${c.cantidad}</td>`; tableUser.appendChild(tr); }); }
  else { tableUser.innerHTML = '<tr><td colspan="4">No hay compras</td></tr>'; histUser.style.display='block'; }
  const purchases = dbGet(KEYS.PURCHASES) || [];
  tableAll.innerHTML = '';
  if (purchases.length){ purchases.slice().reverse().forEach(c=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${new Date(c.fecha).toLocaleString()}</td><td>${c.usuario}</td><td>${c.nombre}</td><td>$${c.precio}</td><td>${c.cantidad}</td>`; tableAll.appendChild(tr); }); }
  else tableAll.innerHTML = '<tr><td colspan="5">Sin compras globales</td></tr>';
}

/* ========== Auth ========== */
toRegister.onclick = ()=> { loginView.style.display='none'; registerView.style.display='block'; msgRegister.textContent=''; }
toLogin.onclick = ()=> { registerView.style.display='none'; loginView.style.display='block'; msgLogin.textContent=''; }

btnRegister.onclick = ()=>{
  const user = (regUser.value||'').trim(); const pass = (regPass.value||'').trim(); const role = regRole.value || 'user';
  if (!user || !pass){ msgRegister.textContent = 'CompletÃ¡ usuario y contraseÃ±a.'; return; }
  const users = dbGet(KEYS.USERS) || [];
  if (users.some(u=>u.user === user)){ msgRegister.textContent = 'Usuario ya existe.'; return; }
  users.push({ user, pass, role, compras: [] }); dbSet(KEYS.USERS, users); setSession(user); regUser.value=''; regPass.value=''; regRole.value='user'; toast('Cuenta creada â€” sesiÃ³n iniciada'); updateUIForSession();
};

btnLogin.onclick = ()=>{
  const user = (loginUser.value||'').trim(); const pass = (loginPass.value||'').trim();
  if (!user || !pass){ msgLogin.textContent = 'CompletÃ¡ usuario y contraseÃ±a.'; return; }
  const users = dbGet(KEYS.USERS) || []; const u = users.find(x=>x.user===user && x.pass===pass);
  if (!u){ msgLogin.textContent = 'Usuario o contraseÃ±a incorrectos.'; return; }
  setSession(user); loginUser.value=''; loginPass.value=''; toast('Bienvenido, ' + user); updateUIForSession();
};

btnLogout.onclick = ()=> { clearSession(); toast('SesiÃ³n cerrada'); updateUIForSession(); };

/* ========== UI update ========== */
function updateUIForSession(){
  const session = getSession();
  if (!session){
    loginView.style.display='block'; registerView.style.display='none'; accountView.style.display='none'; status.textContent='Invitado'; userName.textContent=''; userRole.textContent=''; adminActions.style.display='none'; userActions.style.display='none'; histUser.style.display='none'; histAll.style.display='none'; renderProducts(); return;
  }
  loginView.style.display='none'; registerView.style.display='none'; accountView.style.display='block';
  const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user===session);
  status.textContent = session + ' (' + me.role + ')'; userName.textContent = session; userRole.textContent = me.role;
  if (me.role === 'admin'){ adminActions.style.display='block'; userActions.style.display='block'; } else { adminActions.style.display='none'; userActions.style.display='block'; }
  renderProducts(); renderHistories();
}

/* ========== Add/Edit product panel (with proper FileReader usage) ========== */
let editingId = null;
openAdd.onclick = ()=> openAddPanel();

function openAddPanel(id){
  editingId = id || null;
  addPanel.style.display = 'block'; addMsg.textContent=''; pName.value=''; pPrice.value=''; pStock.value=''; pImage.value=null; pPreview.style.display='none';
  deleteProductBtn.style.display = 'none';
  if (editingId){
    const p = getProducts().find(x=>x.id === editingId);
    if (p){ pName.value = p.nombre; pPrice.value = p.precio; pStock.value = p.stock; if (p.imagen){ pPreview.src = p.imagen; pPreview.style.display='block'; } deleteProductBtn.style.display='inline-block'; }
  }
}

cancelProduct.onclick = ()=> { addPanel.style.display='none'; editingId = null; }

pImage.addEventListener('change', ()=> {
  const f = pImage.files[0];
  if (!f) { pPreview.style.display='none'; return; }
  const fr = new FileReader();
  fr.onload = ()=> { pPreview.src = fr.result; pPreview.style.display='block'; }
  fr.readAsDataURL(f);
});

saveProduct.onclick = ()=>{
  const name = (pName.value||'').trim(); const price = Number(pPrice.value)||0; const stock = Number(pStock.value)||0;
  if (!name || price <= 0 || stock < 0){ addMsg.textContent = 'Completa nombre, precio y stock vÃ¡lidos.'; return; }
  const file = pImage.files[0];
  const apply = (imgData)=>{
    if (!editingId){
      const products = getProducts(); const id = Date.now(); products.push({ id, nombre: name, precio: price, stock: stock, imagen: imgData || '' }); setProducts(products); toast('Producto agregado');
    } else {
      const products = getProducts(); const idx = products.findIndex(p=>p.id === editingId);
      if (idx >= 0){ products[idx] = { ...products[idx], nombre: name, precio: price, stock: stock, imagen: imgData || products[idx].imagen || '' }; setProducts(products); toast('Producto actualizado'); }
    }
    addPanel.style.display='none'; editingId = null; renderProducts();
  };
  if (file){
    const fr = new FileReader();
    fr.onload = ()=> apply(fr.result);
    fr.readAsDataURL(file);
  } else {
    // No new file: keep existing image if editing; otherwise none
    apply(null);
  }
};

deleteProductBtn.onclick = ()=>{
  if (!editingId) return;
  if (!confirm('Eliminar producto?')) return;
  deleteProductById(editingId);
  addPanel.style.display='none'; editingId=null;
};

/* ========== Export CSV & admin actions ========== */
function exportCSV(arr, name){
  if (!arr || !arr.length){ toast('Nada para exportar'); return; }
  const keys = Object.keys(arr[0]);
  const csv = [keys.join(',')].concat(arr.map(r => keys.map(k => JSON.stringify(r[k] ?? '')).join(',')).join('\n'));
  const blob = new Blob(csv, { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

viewAll.onclick = ()=> {
  const session = getSession(); const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user===session);
  if (!me || me.role !== 'admin'){ toast('Acceso denegado'); return; }
  histAll.style.display = histAll.style.display === 'block' ? 'none' : 'block'; renderHistories();
};
exportAll.onclick = ()=> {
  const session = getSession(); const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user===session);
  if (!me || me.role !== 'admin'){ toast('Acceso denegado'); return; }
  const purchases = dbGet(KEYS.PURCHASES) || [];
  exportCSV(purchases.map(p=>({ fecha:p.fecha, usuario:p.usuario, producto:p.nombre, precio:p.precio, cantidad:p.cantidad })), 'historial_global.csv');
};
resetSample.onclick = ()=>{
  if (!confirm('Reiniciar datos de prueba? Esto cerrarÃ¡ tu sesiÃ³n.')) return;
  localStorage.removeItem(KEYS.USERS); localStorage.removeItem(KEYS.PRODUCTS); localStorage.removeItem(KEYS.PURCHASES); localStorage.removeItem(KEYS.SESSION); location.reload();
};
exportMe.onclick = ()=>{
  const session = getSession(); if (!session){ toast('No identificado'); return; }
  const users = dbGet(KEYS.USERS) || []; const me = users.find(u=>u.user === session); if (!me){ toast('Usuario no encontrado'); return; }
  const data = (me.compras || []).map(c => ({ fecha:c.fecha, producto:c.nombre, precio:c.precio, cantidad:c.cantidad }));
  exportCSV(data, `historial_${me.user}.csv`);
};
viewMy.onclick = ()=> { histUser.style.display = histUser.style.display === 'block' ? 'none' : 'block'; renderHistories(); };

/* ========== Init ========== */
function init(){
  renderProducts(); updateUIForSession();
}
init();

/* expose delete for debugging (optional) */
window.deleteProductById = deleteProductById;

/* UX: Enter to login/register */
loginPass.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') btnLogin.click(); });
regPass.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') btnRegister.click(); });
</script>
</body>
</html>
